---
title: 멀티 스레딩과 게임 엔진
date: 2018-10-10
categories:
- Development
tags:
- Development
- Game
---

 단일코어를 넘어 듀얼코어, 쿼드코어 CPU가 생산되고, 현재는 그보다 더 많은 수의 코어를 지원하는 CPU도 개발되었다. 멀티 코어의 시대가 찾아온 것이다. 이런 시대의 흐름에 따라 다수의 유저들은 멀티코어 CPU를 택하기 시작했다.

 하지만 멀티코어를 사용한다고 해서 무조건 적인 성능 향상이 일어나진 않는다. 하드웨어의 스펙이 좋다고 하더라도 소프트웨어가 그 스펙을 지원해줘야 하기 때문이다. 대다수의 게임들 또한 멀티코어 CPU가 개발된 후에도 제대로 이를 지원하지 못했다. ~~최근에도 일반적인 게임들이 쿼드코어보다 많은 코어를 갖춘 CPU를 제대로 지원하지 않아 유저들이 쿼드코어를 CPU로 선택하는 것이 일반적이다~~

 그 이유는 개발자들이 게으른 것이 아니라 게임이 갖는 구조적 특성에 있다. 게임은 프레임 단위로 로직들을 수행하고 로직들이 끝난 후 최신의 정보를 가지고 화면을 다시 그리게 된다. 시간당 많은 프레임이 존재할 수록 화면이 사람의 눈에 부드럽게 인식되고 이 단위를 FPS<sup>Frame Per Second</sup>라고 한다.

![multithreading-game-engine-0](https://user-images.githubusercontent.com/18159012/46985243-5f23a700-d124-11e8-9ab1-3d9cceb30a93.gif)

 프레임 단위로 충돌처리, 애니메이션, 게임 로직, 랜더링 등 많은 기능들이 작동되어야 하고 이런 기능들은 각 게임 오브젝트마다 수행되어야 한다. 때문에 매 프레임 마다 화면안에 존재하는 게임 오브젝트 리스트를 돌며 각 기능을 수행하게 된다.

[그림 - 리스트 돌며 수행]

 단일코어 CPU 환경에서 게임이 위와같이 하나의 스레드 안에서 동작하도록 작성하는 것은 일반적인 것이었다. 단일코어에서 강제로 스레드를 여러개 생성하여 작업을 하게 된다면, 여러 스레드가 동시에 동작하는 것처럼 보여지도록 하나의 코어에 각 스레드가 점유하는 시간을 나눠 동작하게 된다. 이때 컨텍스트 스위칭이 발생하게 되는데, 스레드가 자원을 공유하기 때문에 프로세스 끼리의 그것보다는 양호하겠지만 컨텍스트 스위칭에 대한 비용이 발생하게 된다.

[그림 - 컨텍스트 스위칭]

 하지만 CPU 제조사에서 CPU에 코어 추가를 통한 성능 향상을 꾀하면서 스레드를 하나만 사용하는 엔진이 문제가 되었다. 유저들이 더 쾌적한 환경을 위해 돈을 들여 코어가 추가된 CPU를 구매하였지만 실제 소프트웨어에서 이를 지원하지 않아 실망하는 경우가 많았다.

 때문에 개발자들도 멀티 코어를 지원하는 구조로의 변경에 대해 고민을 하게 되었다. 하지만 개발 중인 프로젝트에 멀티 코어를 위한 구조 변경은 개발 일정에 큰 영향을 줄 수 있기 때문에 모든 로직을 

업데이트 랜더의 액션 기반으로 나눔

 업데이트를 하는 동안 이전 업데이트 데이터를 가지고 랜더

데이터 기반으로 나눔

1. 물리
2. 애니메이션
3. 컬링
4. 랜더

각 데이터 기반으로 나눔, barrier 락, task system

context switch를 줄여야된다

- producer - consumer







하지만 최근들어 이런 시류에 변화의 조짐이 드러나기 시작했다. 코어의 갯수에 따라 퍼포먼스에 차이가 나는 '멀티코어 지원' 게임들이 나타나기 시작했고, AMD가 새롭게 출시한 CPU 라이젠은 제대로 된 헥사코어, 옥타코어 시대를 열었다. 게이머들이 다중코어의 유리함을 조금씩 깨닫기 시작한 것이다.

이런 게이밍 PC 시장에서 일고 있는 다중코어 CPU 열기에 인텔이 불을 지폈다. 인텔이 쿼드코어 이상의 코어 갯수를 지닌 CPU들이 게임에서 보다 나은 퍼포먼스를 낼 수 있는 패치를 낼 것이라는 예고를 한 것이 그 이유다.

코어 갯수가 많은 CPU에서 고품질의 더욱 다양한 효과를 지원하도록 하는 것이 인텔이 이야기한 패치의 핵심 내용이다. 

하지만 인텔의 이런 발표가 마냥 낙관적인 것은 아니다. 인텔이 쿼드코어 이상의 다중코어 CPU에 게이밍 성능을 높일 계획이라 하더라도, 현재 출시된 게임에 대한 사후지원은 게임 개발사가 패치로 진행해야 하는 일이기 때문이다. 

즉, 인텔이 그리고 있는 청사진은 게임업계의 도움이 있어야만 가능한 일인데, 인텔이 이에 대한 어느 정도의 자금지원을 할 것인지가 관건이다.

또한, 추후 출시되는 게임에 대해서만 다중코어 CPU 지원이 적극적으로 진행될 것이라는 관측도 나오고 있다. 이미 완성된 게임의 병렬화 작업이 쉬운 일이 아니기 때문이다. 게다가 지금까지 인텔이 게임 제작사를 대상으로 직접 지원을 한 사례가 드물었기 때문에 인텔의 이번 발표가 현실적으로 와닿지 않는다는 것이 업계 관계자들의 이야기다.

```java
int cores = Runtime.getRuntime().availableProcessors();
// This will give you the number of logical threads. e.g. If you have hyper-threading on, this will be double the number of cores.
```



참조:

https://www.youtube.com/watch?v=M1e9nmmD3II